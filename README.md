# CloudFormation Template for Terraform State Locking and Storage

This CloudFormation template creates the necessary AWS resources for storing and locking Terraform state files. It creates a DynamoDB table for state locking and an S3 bucket to store the Terraform state files.

## Resources Created

- **DynamoDB Table**: Used for state locking to prevent concurrent modifications of Terraform state.
- **S3 Bucket**: Stores Terraform state files with versioning and encryption enabled for security.

## Prerequisites

- An AWS account.
- AWS CLI or AWS Management Console access.
- Permissions to create CloudFormation stacks, DynamoDB tables, and S3 buckets.

## Template Overview

### Parameters

- **funcionName** (required): The name of your Lambda function (or any name you’d like to associate with your state resources). This name will be used to generate unique DynamoDB table and S3 bucket names.

### Resources

- **DynamoDB Table**: This table is used by Terraform to manage state locking. It includes the following:
  - **Partition key**: LockID (used for state locking)
  - On-demand billing mode (no need for provisioning capacity)
  - Server-side encryption enabled for security
  - TTL (Time-to-Live) for automatically cleaning up old lock records
- **S3 Bucket**: This bucket is used to store Terraform state files. It includes:
  - Versioning enabled to track changes to state files
  - Encryption using AES-256 for secure storage

### Outputs

 - **DynamoDBTableName**: The name of the DynamoDB table used for state locking.
 - **S3BucketName**: The name of the S3 bucket used for storing Terraform state.

 You can retrieve the outputs from the AWS CLI:

 ```bash
aws cloudformation describe-stacks --stack-name terraform-state --query "Stacks[0].Outputs"
 ```

## How to use

To deploy this CloudFormation template, follow these steps:

### Use AWS CLI

1. Save the template to a file (e.g., `terraform-state.yaml`).
2. Open the terminal and run the following command to create the CloudFormation stack:

``` bash
aws cloudformation create-stack \
    --stack-name terraform-state \
    --template-body file://terraform-state.yaml \
    --parameters ParameterKey=funcionName,ParameterValue=<your-function-name> \
    --capabilities CAPABILITY_NAMED_IAM
```

Replace `<your-function-name>` with the name of your function (or any name you prefer).

### Using AWS Management Console

1. Open the AWS CloudFormation Console.
2. Click on “Create stack” and choose “Upload a template file.”
3. Upload the CloudFormation template file and provide a stack name (e.g., terraform-state).
4. Under “Parameters,” enter the name for your function (or a custom name) in the funcionName field.
5. Click “Next” and follow the steps to create the stack.

## Using DynamoDB and S3 in Terraform

After the stack is deployed, the DynamoDB table and S3 bucket will be available for use in your Terraform configuration.
Here is an example of how to reference these resources in your `main.tf` file:

``` hcl

provider "aws" {
  region = "us-west-2"
}

# DynamoDB table for state locking
terraform {
  backend "s3" {
    bucket = "terraform-state-${var.funcion_name}"  # Replace with the actual bucket name
    key    = "terraform.tfstate"
    region = "us-west-2"
    dynamodb_table = "terraform-state-${var.funcion_name}"  # Replace with the actual DynamoDB table name
    encrypt = true
  }
}

variable "funcion_name" {
  description = "The name of the function"
  default     = "my-function"
}

```

Make sure to replace the `bucket` and `dynamodb_table` values with the actual names generated by CloudFormation, or use Terraform’s data sources to dynamically retrieve them.

## Cleanup

To delete the CloudFormation stack and the resources it created, run:

``` bash
aws cloudformation delete-stack --stack-name terraform-state
```